name: Update DTEK Outages Schedule

on:
  schedule:
    - cron: '*/6 * * * *'  # Every 6 minutes
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-dtek-schedule:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Fetch DTEK data with Puppeteer
        run: |
          node -e "
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          
          (async () => {
            console.log('Launching browser...');
            const browser = await puppeteer.launch({
              headless: true,
              args: [
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-dev-shm-usage',
                '--disable-accelerated-2d-canvas',
                '--no-first-run',
                '--no-zygote',
                '--single-process',
                '--disable-gpu'
              ]
            });
            
            try {
              const page = await browser.newPage();
              
              // Set realistic viewport and headers
              await page.setViewport({ width: 1920, height: 1080 });
              await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
              
              console.log('Navigating to DTEK page...');
              await page.goto('https://www.dtek-dnem.com.ua/ua/shutdowns', {
                waitUntil: 'networkidle2',
                timeout: 60000
              });
              
              // Wait for DisconSchedule to be available
              console.log('Waiting for DisconSchedule data...');
              await page.waitForFunction('typeof DisconSchedule !== "undefined"', {
                timeout: 30000
              }).catch(() => {
                console.log('DisconSchedule not found, proceeding anyway...');
              });
              
              // Additional wait for any dynamic content
              await new Promise(resolve => setTimeout(resolve, 5000));
              
              console.log('Getting page content...');
              const content = await page.content();
              fs.writeFileSync('raw-dtek-data.html', content);
              console.log('Content saved, length:', content.length);
              
              // Also check if DisconSchedule exists and save its data
              const disconData = await page.evaluate(() => {
                if (typeof DisconSchedule !== 'undefined' && DisconSchedule.fact) {
                  return DisconSchedule.fact;
                }
                return null;
              });
              
              if (disconData) {
                console.log('Found DisconSchedule data!');
                fs.writeFileSync('dtek-raw-data.json', JSON.stringify(disconData, null, 2));
              } else {
                console.log('DisconSchedule data not found in page evaluation');
              }
              
            } catch (error) {
              console.error('Error:', error.message);
              process.exit(1);
            } finally {
              await browser.close();
            }
          })();
          "

      - name: Process DTEK data
        run: |
          node process-dtek-data.js

      - name: Commit and push if changed
        id: commit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/dtek-outages.json
          if git diff --quiet && git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Update DTEK outages schedule [skip ci]"
            git push
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      
